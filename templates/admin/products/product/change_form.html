{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<style>
/* ===== CASCADE NOTES ===== */
.cascade-note {
    background: #dbeafe;
    border: 1px solid #3b82f6;
    padding: 10px 14px;
    margin: 8px 0;
    border-radius: 8px;
    color: #1e40af;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.cascade-note.success { background: #dcfce7; border-color: #22c55e; color: #166534; }
.cascade-note.warning { background: #fef3c7; border-color: #f59e0b; color: #92400e; }
.cascade-note.error { background: #fecaca; border-color: #ef4444; color: #991b1b; }

/* ===== SELECT2 STYLING ===== */
.select2-container { width: 100% !important; max-width: 600px !important; }
.select2-container--default .select2-selection--single,
.select2-container--default .select2-selection--multiple {
    border: 2px solid #e2e8f0 !important;
    border-radius: 8px !important;
    min-height: 44px !important;
    padding: 4px 8px !important;
}
.select2-container--default.select2-container--focus .select2-selection--single,
.select2-container--default.select2-container--focus .select2-selection--multiple {
    border-color: #6366f1 !important;
    box-shadow: 0 0 0 3px rgba(99,102,241,0.15) !important;
}
.select2-container--default .select2-selection--multiple .select2-selection__choice {
    background: linear-gradient(135deg, #6366f1, #8b5cf6) !important;
    border: none !important;
    border-radius: 16px !important;
    padding: 4px 12px !important;
    color: white !important;
    font-size: 12px !important;
}
.select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
    color: white !important;
    margin-right: 6px !important;
}
.select2-dropdown {
    border: 2px solid #e2e8f0 !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1) !important;
}
.select2-container--default .select2-results__option--highlighted[aria-selected] {
    background: #6366f1 !important;
}

/* ===== RICH TEXT EDITOR ===== */
.rich-text-wrapper {
    max-width: 600px;
    margin-top: 5px;
}
.rich-text-wrapper .ql-toolbar {
    border: 2px solid #e2e8f0 !important;
    border-bottom: 1px solid #e2e8f0 !important;
    border-radius: 8px 8px 0 0 !important;
    background: #f8fafc !important;
}
.rich-text-wrapper .ql-container {
    border: 2px solid #e2e8f0 !important;
    border-top: none !important;
    border-radius: 0 0 8px 8px !important;
    font-size: 14px !important;
    min-height: 200px !important;
    background: white !important;
}
.rich-text-wrapper .ql-editor {
    min-height: 200px !important;
    line-height: 1.6 !important;
}
.rich-text-wrapper .ql-editor.ql-blank::before {
    color: #94a3b8 !important;
    font-style: normal !important;
}
.rich-text-wrapper:focus-within .ql-toolbar,
.rich-text-wrapper:focus-within .ql-container {
    border-color: #6366f1 !important;
}

/* ===== FORM BUILDER ===== */
.form-builder-wrapper {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    border-radius: 12px;
    padding: 20px;
    margin: 16px 0;
    box-shadow: 0 8px 30px rgba(99,102,241,0.3);
}
.form-builder-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    color: white;
}
.form-builder-header h3 { margin: 0; font-size: 18px; }
.form-builder-header p { margin: 4px 0 0; opacity: 0.8; font-size: 13px; }
.form-builder-body {
    background: white;
    border-radius: 10px;
    padding: 20px;
}
.field-palette {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 10px;
    padding: 15px;
    background: #f8fafc;
    border-radius: 8px;
    border: 2px dashed #e2e8f0;
    margin-bottom: 16px;
}
.field-type-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    padding: 12px 8px;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
    font-size: 11px;
    color: #64748b;
}
.field-type-btn:hover {
    border-color: #6366f1;
    background: #eef2ff;
    transform: translateY(-2px);
    color: #6366f1;
}
.field-type-btn i { font-size: 20px; }
.fields-list {
    min-height: 100px;
    border: 2px dashed #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    background: #fafafa;
}
.field-item {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px 14px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: all 0.15s;
}
.field-item:hover { border-color: #6366f1; box-shadow: 0 2px 8px rgba(99,102,241,0.1); }
.field-item.selected { border-color: #6366f1; background: #eef2ff; }
.field-item-icon {
    width: 36px;
    height: 36px;
    background: #f1f5f9;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #64748b;
    font-size: 16px;
}
.field-item.selected .field-item-icon { background: #6366f1; color: white; }
.field-item-info { flex: 1; }
.field-item-label { font-weight: 600; color: #1f2937; font-size: 14px; }
.field-item-type { font-size: 12px; color: #64748b; }
.field-item-required {
    background: #fef2f2;
    color: #dc2626;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
}
.field-item-actions { display: flex; gap: 4px; }
.field-item-actions button {
    width: 30px;
    height: 30px;
    border: none;
    border-radius: 6px;
    background: transparent;
    cursor: pointer;
    color: #64748b;
    font-size: 12px;
    transition: all 0.15s;
}
.field-item-actions button:hover { background: #f1f5f9; }
.field-item-actions button.del:hover { background: #fef2f2; color: #dc2626; }
.field-settings {
    background: #f8fafc;
    border-radius: 8px;
    padding: 18px;
    margin-top: 16px;
    display: none;
    border: 1px solid #e2e8f0;
}
.field-settings.active { display: block; }
.field-settings h4 { margin: 0 0 14px; color: #1f2937; font-size: 15px; }
.settings-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
}
.settings-group { display: flex; flex-direction: column; gap: 5px; }
.settings-group label { font-size: 12px; font-weight: 600; color: #374151; }
.settings-group input, .settings-group select {
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 13px;
}
.toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 14px;
    background: white;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    margin-top: 14px;
}
.toggle-switch { position: relative; display: inline-block; width: 48px; height: 26px; }
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background: #d1d5db;
    transition: .3s;
    border-radius: 26px;
}
.toggle-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background: white;
    transition: .3s;
    border-radius: 50%;
}
.toggle-switch input:checked + .toggle-slider { background: #6366f1; }
.toggle-switch input:checked + .toggle-slider:before { transform: translateX(22px); }
.options-container { margin-top: 14px; }
.option-row { display: flex; gap: 8px; margin-bottom: 8px; }
.option-row input { flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; }
.option-row button { padding: 10px; border: none; border-radius: 6px; background: #fef2f2; color: #dc2626; cursor: pointer; }
.add-option-btn {
    width: 100%;
    padding: 12px;
    border: 2px dashed #d1d5db;
    border-radius: 6px;
    background: transparent;
    color: #6b7280;
    cursor: pointer;
    margin-top: 8px;
    font-size: 13px;
}
.add-option-btn:hover { border-color: #6366f1; color: #6366f1; }
.empty-fields { text-align: center; padding: 40px; color: #94a3b8; }
.empty-fields i { font-size: 36px; margin-bottom: 10px; opacity: 0.5; }
</style>
{% endblock %}

{% block after_related_objects %}
{{ block.super }}

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
(function($) {
    'use strict';
    
    console.log('üöÄ Product Admin JS Loading...');
    
    // Field Types
    var FIELD_TYPES = [
        {type:'text', icon:'fa-font', label:'Text'},
        {type:'textarea', icon:'fa-align-left', label:'Long Text'},
        {type:'email', icon:'fa-envelope', label:'Email'},
        {type:'phone', icon:'fa-phone', label:'Phone'},
        {type:'number', icon:'fa-hashtag', label:'Number'},
        {type:'date', icon:'fa-calendar', label:'Date'},
        {type:'dropdown', icon:'fa-chevron-down', label:'Dropdown'},
        {type:'checkbox', icon:'fa-check-square', label:'Checkbox'},
        {type:'radio', icon:'fa-circle-dot', label:'Radio'},
        {type:'file', icon:'fa-file-upload', label:'File'},
        {type:'image', icon:'fa-image', label:'Image'},
        {type:'aadhar', icon:'fa-id-card', label:'Aadhar'},
        {type:'pan', icon:'fa-credit-card', label:'PAN'},
        {type:'pincode', icon:'fa-map-pin', label:'Pincode'}
    ];
    
    var formFields = [];
    var selectedFieldId = null;
    
    $(document).ready(function() {
        console.log('‚úÖ Document Ready!');
        
        setTimeout(function() {
            initRichTextEditor();
            initCategoryFilter();
            initStateFilter();
            initFormBuilder();
            console.log('‚úÖ All components initialized!');
        }, 300);
    });
    
    // ==================== RICH TEXT EDITOR ====================
    function initRichTextEditor() {
        // Find description field - try multiple possible IDs
        var $desc = $('#id_description');
        if (!$desc.length) {
            $desc = $('#id_full_description');
        }
        if (!$desc.length) {
            $desc = $('textarea[name="description"]');
        }
        if (!$desc.length) {
            $desc = $('textarea[name="full_description"]');
        }
        
        if (!$desc.length) {
            console.log('‚ö†Ô∏è Description textarea not found');
            return;
        }
        
        if (typeof Quill === 'undefined') {
            console.log('‚ö†Ô∏è Quill not loaded');
            return;
        }
        
        console.log('‚úÖ Rich Text Editor initializing for:', $desc.attr('id') || $desc.attr('name'));
        
        // Create wrapper and editor
        var editorId = 'quill-editor-' + Date.now();
        var $wrapper = $('<div class="rich-text-wrapper"><div id="' + editorId + '"></div></div>');
        
        // Hide original textarea and add editor
        $desc.hide().after($wrapper);
        
        // Initialize Quill
        var quill = new Quill('#' + editorId, {
            theme: 'snow',
            placeholder: 'Enter description here...',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'align': [] }],
                    ['link', 'image'],
                    ['clean']
                ]
            }
        });
        
        // Set initial content
        var initialContent = $desc.val();
        if (initialContent) {
            quill.root.innerHTML = initialContent;
        }
        
        // Sync content back to textarea on change
        quill.on('text-change', function() {
            $desc.val(quill.root.innerHTML);
        });
        
        // Also sync before form submit
        $desc.closest('form').on('submit', function() {
            $desc.val(quill.root.innerHTML);
        });
        
        console.log('‚úÖ Rich Text Editor ready!');
    }
    
    // ==================== CATEGORY ‚Üí SUBCATEGORY ====================
    function initCategoryFilter() {
        var $cat = $('#id_category');
        var $subcat = $('#id_subcategory');
        
        if (!$cat.length || !$subcat.length) {
            console.log('‚ö†Ô∏è Category fields not found');
            return;
        }
        
        console.log('‚úÖ Category filter init');
        var currentSub = $subcat.val();
        
        $cat.after('<div class="cascade-note" id="cat-note"><i class="fas fa-info-circle"></i> Select category</div>');
        
        $cat.on('change', function() {
            var catId = $(this).val();
            if (!catId) {
                $subcat.html('<option value="">---------</option>');
                $('#cat-note').removeClass('success warning error').html('<i class="fas fa-info-circle"></i> Select category');
                return;
            }
            
            $('#cat-note').addClass('warning').removeClass('success error').html('<i class="fas fa-spinner fa-spin"></i> Loading...');
            
            $.get('/admin/products/product/ajax/get-subcategories/', {category_id: catId})
                .done(function(data) {
                    $subcat.html('<option value="">---------</option>');
                    if (data.subcategories && data.subcategories.length) {
                        data.subcategories.forEach(function(s) {
                            var sel = s.id == currentSub ? ' selected' : '';
                            $subcat.append('<option value="'+s.id+'"'+sel+'>'+s.name+'</option>');
                        });
                        $('#cat-note').removeClass('warning error').addClass('success').html('<i class="fas fa-check-circle"></i> '+data.subcategories.length+' subcategories loaded');
                    } else {
                        $('#cat-note').removeClass('success error').addClass('warning').html('<i class="fas fa-exclamation-triangle"></i> No subcategories found');
                    }
                })
                .fail(function() {
                    $('#cat-note').removeClass('success warning').addClass('error').html('<i class="fas fa-times-circle"></i> Error loading!');
                });
        });
        
        if ($cat.val()) $cat.trigger('change');
    }
    
    // ==================== STATE ‚Üí CITY ====================
    function initStateFilter() {
        var $states = $('#id_available_states');
        var $cities = $('#id_available_cities');
        
        if (!$states.length || !$cities.length) {
            console.log('‚ö†Ô∏è State/City fields not found');
            return;
        }
        
        console.log('‚úÖ State filter init');
        var currentCities = $cities.val() || [];
        
        // Initialize Select2
        try {
            $states.select2({width: '100%', placeholder: 'üîç Select states...', allowClear: true});
            $cities.select2({width: '100%', placeholder: 'üîç Select cities...', allowClear: true});
            console.log('‚úÖ Select2 initialized');
        } catch(e) {
            console.log('‚ö†Ô∏è Select2 error:', e);
        }
        
        $states.closest('.form-row').append('<div class="cascade-note" id="state-note"><i class="fas fa-info-circle"></i> Select state</div>');
        
        $states.on('change', function() {
            var stateIds = $(this).val();
            if (!stateIds || !stateIds.length) {
                $cities.html('<option value="">-- Select state first --</option>').trigger('change');
                $('#state-note').removeClass('success warning error').html('<i class="fas fa-info-circle"></i> Select state');
                return;
            }
            
            $('#state-note').addClass('warning').removeClass('success error').html('<i class="fas fa-spinner fa-spin"></i> Loading cities...');
            
            $.get('/admin/products/product/ajax/get-cities/', {state_ids: stateIds.join(',')})
                .done(function(data) {
                    $cities.empty();
                    if (data.cities && data.cities.length) {
                        data.cities.forEach(function(c) {
                            var sel = currentCities.indexOf(String(c.id)) > -1 ? ' selected' : '';
                            var label = c.name + (c.state__code ? ' (' + c.state__code + ')' : '');
                            $cities.append('<option value="'+c.id+'"'+sel+'>'+label+'</option>');
                        });
                        $cities.trigger('change');
                        $('#state-note').removeClass('warning error').addClass('success').html('<i class="fas fa-check-circle"></i> '+data.cities.length+' cities loaded');
                    } else {
                        $cities.html('<option value="">-- No cities found --</option>').trigger('change');
                        $('#state-note').removeClass('success error').addClass('warning').html('<i class="fas fa-exclamation-triangle"></i> No cities found');
                    }
                })
                .fail(function() {
                    $('#state-note').removeClass('success warning').addClass('error').html('<i class="fas fa-times-circle"></i> Error loading!');
                });
        });
        
        if ($states.val() && $states.val().length) $states.trigger('change');
    }
    
    // ==================== FORM BUILDER ====================
    function initFormBuilder() {
        var $schema = $('#id_form_schema');
        if (!$schema.length) {
            console.log('‚ö†Ô∏è Form schema field not found');
            return;
        }
        
        console.log('‚úÖ Form Builder init');
        
        // Parse existing
        try {
            var val = $schema.val();
            if (val && val !== '[]' && val !== 'null' && val.trim() !== '') {
                formFields = JSON.parse(val);
                if (!Array.isArray(formFields)) formFields = [];
            }
        } catch(e) {
            console.log('‚ö†Ô∏è Parse error:', e);
            formFields = [];
        }
        console.log('üìã Existing fields:', formFields.length);
        
        // Find fieldset
        var $fieldset = null;
        $('fieldset h2, fieldset legend').each(function() {
            var text = $(this).text().toLowerCase();
            if (text.indexOf('form') > -1 && text.indexOf('builder') > -1) {
                $fieldset = $(this).closest('fieldset');
            }
        });
        
        if (!$fieldset) {
            // Try finding by form_schema field
            $fieldset = $schema.closest('fieldset');
        }
        
        if (!$fieldset || !$fieldset.length) {
            console.log('‚ö†Ô∏è Form Builder fieldset not found');
            return;
        }
        
        // Hide original
        $schema.closest('.form-row').hide();
        
        // Create UI
        var html = '<div class="form-builder-wrapper">' +
            '<div class="form-builder-header">' +
            '<div><i class="fas fa-magic" style="font-size:28px;"></i></div>' +
            '<div><h3>Visual Form Builder</h3><p>Click buttons to add form fields</p></div>' +
            '</div>' +
            '<div class="form-builder-body">' +
            '<h4 style="margin:0 0 12px;font-size:14px;color:#374151;"><i class="fas fa-plus-circle" style="color:#6366f1;"></i> Add Field Types</h4>' +
            '<div class="field-palette" id="fieldPalette"></div>' +
            '<h4 style="margin:20px 0 12px;font-size:14px;color:#374151;"><i class="fas fa-list" style="color:#10b981;"></i> Form Fields (<span id="fieldCount">0</span>)</h4>' +
            '<div class="fields-list" id="fieldsList"></div>' +
            '<div class="field-settings" id="fieldSettings"></div>' +
            '</div></div>';
        
        $fieldset.find('.form-row').first().before(html);
        
        renderPalette();
        renderFields();
        
        console.log('‚úÖ Form Builder ready!');
    }
    
    function renderPalette() {
        var $p = $('#fieldPalette');
        if (!$p.length) return;
        
        var html = '';
        FIELD_TYPES.forEach(function(f) {
            html += '<button type="button" class="field-type-btn" data-type="' + f.type + '">' +
                '<i class="fas ' + f.icon + '"></i>' +
                '<span>' + f.label + '</span></button>';
        });
        $p.html(html);
        
        $p.find('.field-type-btn').on('click', function() {
            addField($(this).data('type'));
        });
    }
    
    function renderFields() {
        var $list = $('#fieldsList');
        var $count = $('#fieldCount');
        if (!$list.length) return;
        
        $count.text(formFields.length);
        
        if (formFields.length === 0) {
            $list.html('<div class="empty-fields"><i class="fas fa-inbox"></i><p>No fields added yet.<br>Click buttons above to add fields.</p></div>');
            return;
        }
        
        var html = '';
        formFields.forEach(function(f, i) {
            var cfg = FIELD_TYPES.find(function(t) { return t.type === f.field_type; }) || {icon:'fa-font', label:f.field_type};
            var sel = selectedFieldId === f.id ? ' selected' : '';
            
            html += '<div class="field-item' + sel + '" data-id="' + f.id + '">' +
                '<div class="field-item-icon"><i class="fas ' + cfg.icon + '"></i></div>' +
                '<div class="field-item-info">' +
                '<div class="field-item-label">' + f.label + '</div>' +
                '<div class="field-item-type">' + cfg.label + '</div></div>' +
                (f.required ? '<span class="field-item-required">Required</span>' : '') +
                '<div class="field-item-actions">' +
                '<button type="button" class="up" title="Move Up"' + (i === 0 ? ' disabled style="opacity:0.3"' : '') + '><i class="fas fa-chevron-up"></i></button>' +
                '<button type="button" class="down" title="Move Down"' + (i === formFields.length - 1 ? ' disabled style="opacity:0.3"' : '') + '><i class="fas fa-chevron-down"></i></button>' +
                '<button type="button" class="del" title="Delete"><i class="fas fa-trash"></i></button>' +
                '</div></div>';
        });
        $list.html(html);
        
        // Bind events
        $list.find('.field-item').on('click', function(e) {
            if (!$(e.target).closest('.field-item-actions').length) {
                selectField($(this).data('id'));
            }
        });
        $list.find('.up').on('click', function(e) { e.stopPropagation(); moveField($(this).closest('.field-item').data('id'), 'up'); });
        $list.find('.down').on('click', function(e) { e.stopPropagation(); moveField($(this).closest('.field-item').data('id'), 'down'); });
        $list.find('.del').on('click', function(e) { e.stopPropagation(); deleteField($(this).closest('.field-item').data('id')); });
        
        saveSchema();
    }
    
    function showSettings(fieldId) {
        var f = formFields.find(function(x) { return x.id === fieldId; });
        if (!f) return;
        
        var $panel = $('#fieldSettings');
        var hasOpts = ['dropdown', 'checkbox', 'radio'].indexOf(f.field_type) !== -1;
        var isFile = ['file', 'image'].indexOf(f.field_type) !== -1;
        
        var optsHtml = '';
        if (hasOpts) {
            optsHtml = '<div class="options-container"><label style="font-weight:600;display:block;margin-bottom:8px;font-size:13px;">Options</label>';
            (f.options || []).forEach(function(o, i) {
                optsHtml += '<div class="option-row"><input type="text" value="' + (o.label || o) + '" data-idx="' + i + '" class="opt-input" placeholder="Option text">' +
                    '<button type="button" class="opt-remove" data-idx="' + i + '"' + ((f.options || []).length <= 1 ? ' disabled style="opacity:0.3"' : '') + '><i class="fas fa-times"></i></button></div>';
            });
            optsHtml += '<button type="button" class="add-option-btn"><i class="fas fa-plus"></i> Add Option</button></div>';
        }
        
        var fileHtml = '';
        if (isFile) {
            fileHtml = '<div style="background:#fef3c7;padding:14px;border-radius:8px;margin-top:14px;">' +
                '<h5 style="margin:0 0 12px;color:#92400e;font-size:13px;"><i class="fas fa-upload"></i> Upload Settings</h5>' +
                '<div class="settings-grid">' +
                '<div class="settings-group"><label>Max Files</label><input type="number" class="max-files" value="' + (f.validation && f.validation.max_files || 1) + '" min="1" max="10"></div>' +
                '<div class="settings-group"><label>Max Size (MB)</label><input type="number" class="max-size" value="' + (f.validation && f.validation.max_file_size_mb || 5) + '" min="1" max="50"></div>' +
                '</div></div>';
        }
        
        $panel.html(
            '<h4><i class="fas fa-cog" style="color:#6366f1;"></i> Field Settings</h4>' +
            '<div class="settings-grid">' +
            '<div class="settings-group"><label>Label *</label><input type="text" class="f-label" value="' + f.label + '" placeholder="Field label"></div>' +
            '<div class="settings-group"><label>Field ID</label><input type="text" value="' + f.name + '" readonly style="background:#f1f5f9;cursor:not-allowed;"></div>' +
            '<div class="settings-group"><label>Placeholder</label><input type="text" class="f-placeholder" value="' + (f.placeholder || '') + '" placeholder="Placeholder text"></div>' +
            '<div class="settings-group"><label>Help Text</label><input type="text" class="f-help" value="' + (f.help_text || '') + '" placeholder="Help text"></div>' +
            '</div>' +
            '<div class="toggle-row"><div><strong style="font-size:14px;">Required Field</strong><br><small style="color:#64748b;">Make this field mandatory</small></div>' +
            '<label class="toggle-switch"><input type="checkbox" class="f-required"' + (f.required ? ' checked' : '') + '><span class="toggle-slider"></span></label></div>' +
            optsHtml + fileHtml
        ).addClass('active');
        
        // Bind events
        $panel.find('.f-label').on('input', function() { updateField(fieldId, 'label', $(this).val()); });
        $panel.find('.f-placeholder').on('input', function() { updateField(fieldId, 'placeholder', $(this).val()); });
        $panel.find('.f-help').on('input', function() { updateField(fieldId, 'help_text', $(this).val()); });
        $panel.find('.f-required').on('change', function() { updateField(fieldId, 'required', $(this).is(':checked')); });
        $panel.find('.opt-input').on('input', function() { updateOption(fieldId, $(this).data('idx'), $(this).val()); });
        $panel.find('.opt-remove').on('click', function() { removeOption(fieldId, $(this).data('idx')); });
        $panel.find('.add-option-btn').on('click', function() { addOption(fieldId); });
        $panel.find('.max-files').on('change', function() { updateValidation(fieldId, 'max_files', parseInt($(this).val())); });
        $panel.find('.max-size').on('change', function() { updateValidation(fieldId, 'max_file_size_mb', parseInt($(this).val())); });
    }
    
    function saveSchema() {
        var $sf = $('#id_form_schema');
        if ($sf.length) {
            $sf.val(JSON.stringify(formFields));
        }
    }
    
    function addField(type) {
        var cfg = FIELD_TYPES.find(function(t) { return t.type === type; });
        var label = cfg ? cfg.label : 'Field';
        var newField = {
            id: 'field_' + Date.now(),
            field_type: type,
            label: label,
            name: label.toLowerCase().replace(/[^a-z0-9]+/g, '_'),
            placeholder: '',
            help_text: '',
            required: false,
            order: formFields.length + 1,
            validation: {},
            options: ['dropdown', 'checkbox', 'radio'].indexOf(type) !== -1 ? [{label: 'Option 1', value: 'option_1'}] : []
        };
        if (['file', 'image'].indexOf(type) !== -1) {
            newField.validation = {max_files: 1, max_file_size_mb: 5};
        }
        formFields.push(newField);
        selectedFieldId = newField.id;
        renderFields();
        showSettings(newField.id);
    }
    
    function selectField(id) {
        selectedFieldId = id;
        renderFields();
        showSettings(id);
    }
    
    function deleteField(id) {
        if (!confirm('Are you sure you want to delete this field?')) return;
        formFields = formFields.filter(function(f) { return f.id !== id; });
        if (selectedFieldId === id) {
            selectedFieldId = null;
            $('#fieldSettings').removeClass('active');
        }
        renderFields();
    }
    
    function moveField(id, dir) {
        var idx = formFields.findIndex(function(f) { return f.id === id; });
        if ((dir === 'up' && idx === 0) || (dir === 'down' && idx === formFields.length - 1)) return;
        var newIdx = dir === 'up' ? idx - 1 : idx + 1;
        var temp = formFields[idx];
        formFields[idx] = formFields[newIdx];
        formFields[newIdx] = temp;
        renderFields();
    }
    
    function updateField(id, key, value) {
        var f = formFields.find(function(x) { return x.id === id; });
        if (!f) return;
        f[key] = value;
        if (key === 'label') {
            f.name = value.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '') || 'field';
        }
        renderFields();
        if (key === 'label') showSettings(id); // Refresh to show updated ID
    }
    
    function updateValidation(id, key, value) {
        var f = formFields.find(function(x) { return x.id === id; });
        if (!f) return;
        if (!f.validation) f.validation = {};
        f.validation[key] = value;
        saveSchema();
    }
    
    function addOption(id) {
        var f = formFields.find(function(x) { return x.id === id; });
        if (!f) return;
        if (!f.options) f.options = [];
        var num = f.options.length + 1;
        f.options.push({label: 'Option ' + num, value: 'option_' + num});
        showSettings(id);
        saveSchema();
    }
    
    function updateOption(id, idx, value) {
        var f = formFields.find(function(x) { return x.id === id; });
        if (!f || !f.options || !f.options[idx]) return;
        f.options[idx] = {label: value, value: value.toLowerCase().replace(/[^a-z0-9]+/g, '_')};
        saveSchema();
    }
    
    function removeOption(id, idx) {
        var f = formFields.find(function(x) { return x.id === id; });
        if (!f || !f.options || f.options.length <= 1) return;
        f.options.splice(idx, 1);
        showSettings(id);
        saveSchema();
    }
    
})(django.jQuery);
</script>
{% endblock %}
